# Миграция на MediaMTX

Предварительно надо установить на сервер MediaMTX согласно [инструкции](install/README.md).

**Внимание!** Если адрес сервера вещания и основного сервера отличаются, необходимо исправить файл `src/utils/getStream.js` в репозитории [Rockwell_front](https://github.com/Data-Acquisition/Rockwell_front), исправив функцию `getCameraPlayerUrl`


## Сервис ретрансляции

Предназначен для получения потока с камеры и последующей ретрансляции его на сервер вещания, откуда он, в дальнейшем, может быть просмотрен пользователями, сохранен в архив или проанализирован. Необходимость ретрансляции определяется тем, что IP-камера представляет собой достаточно слабое с точки зрения ресурсов процессора устройство, которое не очень хорошо реагирует на большое число подключений. Сервер вещания, в свою очередь, обычно устанавливается на мощных серверах и может дублировать поток на большое число потребителей.

Логика работы сервера ретрансляций:
* запускается и устанавливает соединение с СУБД;
* запрашивает список текущих камер;
* формирует для полученных камер RTSP-адреса;
* для каждой камеры выполняет следующий набор действий:
  * проверяет доступность камеры и наличия у нее аудио;
  * в случае, если камера недоступна, то повторяет проверку через некоторое время;
  * если камера доступна - создает команду ретрансляции на сервер вещания;
  * отслеживает работоспособность процесса ретрансляции, в случае прерывания - проверяет актуальность адреса камеры (наличие его в БД);
  * если камера отсутствует в БД - процесс завершается;
  * если камера наличествует - процесс ретрансляции перезапускается.
* периодически проверяет список текущих камер на изменения и запускает новые процессы ретрансляции в случае необходимости.

Сервис написан на языке Python 3 (версия 3.10) и использует библиотеку `asyncpg` для доступа к БД PostgreSQL. 

### Структура сервиса

  * `etc`
    * `restream_log.conf` - конфигурация логирования для сервиса, через нее можно указать куда складывать файлы журналов и сколько и какой информации в них должно содержаться;
  * `log` - каталог журналов по умолчанию. В начальном состоянии пуст;
  * `src`
    * `db.py` - модуль работы с БД. Выполняет запрос к таблице камер и преобразует полученные данные в нужный формат;
    * `ffmpeg.py` - модуль для работы с медиа-потоками. Делает проверку входящего адреса потока и собирает команду для ретрансляции;
    * `main.py` - модуль запуска сервиса;
    * `state.py` - собственно состояние сервиса. Отслеживает изменения состояния данных из БД и процессов ретрансляции и выполняет запуск/останов по необходимости;
  * `requiments.txt` - список зависимостей сервиса;
  * `restream.service` - пример описания сервиса для установки под супервизор `systemd`;
  * `srvc_restream.py` - точка входа в сервис. Анализирует параметры среды и командной строки и передает их в модуль запуска;
  * `start.sh` - пример сценария запуска.


### Запуск сервиса

 * (если необходимо) иницировать локальную среду установки `virtualenv -p3 .env` и активировать в текущем терминале `. .env/bin/activate`;
 * отредактировать файл `start.sh`, указав в переменной среды `PG_DSN` корректный адрес для доступа к СУБД PostgreSQL. Для тестирования можно использовать пустую базу с таблицей `cameras`, аналогичной по структуре одноименной в данном проекте;
 * запустить `./start.sh` - будет поизведена установка зависимостей и произойдет запуск сервиса в консольном режиме. 

Вместо переменной среды окружения `PG_DSN` можно воспользоваться параметром командной строки `--pg_dsn=postgresql://...`, если это удобнее. Значение переменной окружения имеет приоритет над значением параметра командной строки.

Для работоспособности комплекса требуются утилиты `ffmpeg` и `ffprobe`, которые лучше всего устрановить из репозитория используемого дистрибутива (обычно они находятся в одном пакете `ffmpeg`).

Перед запуском медиа-сервер MediaMTX должен быть [установлен и запущен](install/README.md), а камеры из СУБД - доступны. В противном случае процесс ретрансляции прекратит функционирования и будет перезапущен через 5 секунд. Перезапуск произойдет также, если URL камеры был изменен. В случае некорректного URL или недоступности камеры сервис будет периодически пытаться запустить ретранслятор до момента, пока запись о камере не будет удалена из таблицы, URL не будет исправен или камера окажется доступной.

В случае, если сервис ретрансляции и медиа-сервер находятся на разных платформах, то точку вещания можно скорректировать, исправив в файле `ffmpeg.py` переменные `MEDIA_SERVER_HOST` и `MEDIA_SERVER_PORT`. Предполагается, что это достаточно редкий сценарий, поэтому данные переменные не были вынесены в конфигурацию сервиса.

Также в случае увеличения количества типов камер необходимо скорректировать функцию формировать URL потоков. Данная функция называется `to_url()` и находится в файле `db.py`.


### Типовые проблемы и способы разрешения

Раздел будет заполнен в процессе эксплуатации сервиса.
